#computer 

---
# 文件的基本概念

- 文件：有意义信息的组合

思考三个问题：
- 一个文件有哪些属性？
	- 文件名：方便用户找到（不允许重名）
	- 标识符：对用户没有可读性，是 OS 用来区分各个文件的标识
	- 类型
	- 位置：文件存放路径（用户视角）、外存中地址（OS 视角，用户不可见）
	- 大小
	- 创建时间、上次修改时间
	- 文件所有者信息
	- 保护信息
- *文件内部*的数据应该怎样组织起来？
	- **无结构文件**/流式文件：二进制或字符流组成
	- **有结构文件**/记录式文件：由多组相似的记录组成
		- 记录：一组相关数据项的集合
		- 数据项：文件系统中最基本的数据单位
		- **对于有结构文件，各个记录如何组织，即文件的逻辑结构问题**
- *文件之间*应该怎样组织起来？
	- 目录结构

回顾计算机操作系统的层级结构：
![](img/Pasted%20image%2020240101102932.png)

结合操作系统层级结构，思考：
- 从下往上看，OS 应该为用户/应用提供哪些功能？
	- *创建文件*：create 系统调用
	- *读文件*：read 系统调用（外存读入内存）
	- *写文件*：write 系统调用（内存写入外存）
	- *删除文件*：delete 系统调用（从外存中删除）
	- *打开/关闭文件*：open/close 系统调用
	- 几个基本操作进行组合来实现复杂功能
	- 其他功能：
		- *文件共享*
		- *文件保护*
- 从上往下看，文件数据如何存放在外存/磁盘上？
	- 类似于内存，外存也被分为一个个*大小相等（一般是 2 的整数幂）*的“块/磁盘块/物理块”
	- 外存的逻辑地址 = 逻辑块号 + 块内地址，OS 负责逻辑到物理地址（物理块号、快内地址）的转换
	- 快内地址的位数取决于磁盘块的大小
	- **文件的物理结构**：文件数据连续存放/离散存放（如何记录磁盘块顺序）
	- OS 如何管理空闲磁盘块


综上，本章节要研究的问题：
- **文件内的逻辑结构**
- **文件间的目录结构**
- **文件存储的物理结构**
- OS 提供的功能
	- **存储空间的管理**

---
# 文件内的逻辑结构

逻辑结构
- 用户视角：文件内部的数据如何被组织起来
物理结构
- OS 视角：文件的数据如何存放在外存中

对于逻辑结构：
- **无结构文件**
- **有结构文件**
	- 顺序文件
	- 索引文件
	- 索引顺序文件
## 无结构文件
## 有结构文件

由一组相似的记录组成（记录式文件），每个记录由若干个数据项组成，每个记录有一个数据项作为*关键字*

根据记录长度（占用存储空间）是否相等：
- *定长记录*
- *可变长记录*

### 顺序文件

根据物理上是否相邻，分为：
- 链式存储：逻辑上相邻、物理上不相邻
	- 无法随机存取
- 顺序存储：逻辑上相邻、物理上相邻
	- 可变长：无法随机存取
	- 定长：可以随机存取
		- *串结构*：记录之间顺序与关键字无关
			- 无法根据关键字直接找到对应记录
		- *顺序结构*：记录之间顺序按照关键字相关的顺序排列
			- 可利用关键字快速检索

### 索引文件

为了解决可变长记录文件中，快速查找指定记录的需求
- 利用另一个*定长记录的顺序文件*，来为每条记录映射一个*索引项*
- 这个*定长记录顺序文件*为**索引表**
- 不同的数据项都可以建立一个索引表
![](img/Pasted%20image%2020240101110618.png)

**主要使用在对信息处理的及时性要求比较高的场合**

### 索引顺序文件

索引表的缺点：每个记录对应一个索引表项，可能导致索引表会很大
- *让多个记录对应同一个索引表项*，从而减少索引表的大小，同时也可以减少关键字检索次数

进一步减少检索次数：
- 建立**多级索引顺序文件**

---
# 文件间的目录结构

## 文件控制块

目录本身就是一种结构文件，由一条条记录组成，每条记录对应一个在该目录下的文件

**文件控制块 FCB**：有序集合，“文件目录”，*对应一个文件目录项*
- 文件的基本信息（*文件名*、*物理地址*，逻辑结构、物理结构等）
- 存取控制信息（读写权限、禁止访问用户名单）
- 使用信息（建立时间、修改时间）
实现了文件名和文件之间的映射，“按名存取”

对目录的操作：
- 搜索：按文件名搜索目录，找到对应目录项
- 创建文件：所属目录中增加目录项
- 删除文件：所属目录中删除目录项
- 显示目录
- 修改目录：如文件重命名、移动存放位置等

## 目录结构

- **单级目录结构**
	- 按名存取，不允许文件重名
	- *不适合多用户操作系统*
- **两级目录结构**
	- 主文件目录，MFD，master file directory
	- 用户文件目录，UFD，user file directory
	- 允许不同用户的文件重名，但无法对自己的文件分类
- **多级目录结构**（树形目录结构）
	- 不同目录下文件可以重名
	- *绝对路径*，根目录出发的路径
		- 系统根据绝对路径*一层一层查找下一级目录*：
			- 外存读入根目录的目录表
			- 找到目标目录的存放位置，从外存读入对应目录表
			- 再找到下级目标目录的存放位置，从外存读入对应目录表
			- 最后找到目标文件位置
			- 上述过程经过了 3 次读磁盘 IO 操作
		- 每次都从根目录一层层找很低效
	- *相对路径*：从当前目录出发
	- *树形结构不便于实现文件的共享*
- **无环图目录结构**
	- 树型结构基础上增加一些指向同一节点的有向边
	- 方便多个用户间的文件共享，甚至是同一个目录
	- *对共享结点设置一个共享计数器*
		- 用户删除共享节点，只会删除该用户的 FCB，*共享计数器-1*
		- 共享计数器为 0 时才会真正删除该结点

## 索引节点（文件控制块的优化）

- FCB 数据结构的改进

FCB 中查找各级目录过程中，只需要“*文件名*”，只有文件名匹配时才需要显示其他相关信息，所以可以考虑简化目录表结构，如下图
![](img/Pasted%20image%2020240102095051.png)

- 存放在外存中的索引节点：*磁盘索引结点*
- 放入内存后：*内存索引结点*
	- 此时要增加一些信息：是否被修改，有几个进程在访问

---
操作系统对磁盘块的管理：
- 非空闲磁盘块的管理
- 空闲磁盘块的管理
---
# 文件的物理结构

## 概念补充

- 文件块、磁盘块：与内存分页类似，对磁盘存储单元同样分为一个个与内存块、页面的大小相同的块
- 逻辑地址同样：逻辑块号+块内地址
操作系统将文件不同的逻辑块号放入不同磁盘块中

*操作系统如何将这些逻辑块号分配到不同的磁盘块中呢？*

## 连续分配

*每个文件在磁盘上占有一组连续的块，并保持文件逻辑块的相对顺序*

操作系统如何实现？

用户使用逻辑块号+块内地址，操作系统负责实现逻辑地址到物理地址的映射

- 用户给出逻辑地址
- OS 找到文件的 FCB
- 物理块号 = 起始块号 + 逻辑块号
- 检查逻辑块号是否合法（>=长度不合法）
**优点 1**：*支持顺序访问和直接访问*（随机访问）

前提，读取某个磁盘块时需要移动磁头，磁盘块之间相隔越远，移动磁头所需要的时间就越长
**优点 2**：*顺序读写时速度最快*

**缺点**：
- 连续分配的文件，拓展空间不方便（该文件存储位置后可能已经被其他文件数据占用）
- 存储空间利用率低，会产生磁盘碎片（外部碎片）

## 链接分配

- 离散分配的方式，离散的磁盘块，通过指针*隐式链接*和*显式链接*

### 隐式链接

![](img/Pasted%20image%2020240102100511.png)

**逻辑地址到物理地址的转变：**
不同逻辑块号存放的物理块中会隐式包含指向下一个物理块的指针
- 用户给出逻辑地址（逻辑块号 i），OS 找到对应的 FCB
- 从 FCB 中找到起始块号，从第一个块号开始找起，依次获得下一个物理块位置
- 总共需要 i+1 次磁盘 IO 

**优缺点**：
只支持顺序访问，不支持随机访问，查找效率低
指针消耗存储空间
文件拓展方便

### 显式链接

![](img/Pasted%20image%2020240102100800.png)
- 链接文件各物理块的指针进行显式记录在文件分配表中（FAT、File Allocation Table）

**一个磁盘只设置一张 FAT，开机时 FAT 读入内存，并常驻内存**
FAT 在物理上连续存储，其物理块号是隐含的

**逻辑地址到物理地址的转变**：
- FCB 中找到起始块号，i>0 则查询内存中的 FAT
- 找到 i 号逻辑块对应的物理块号
- *该过程不需要读磁盘操作*

**优缺点**：
支持顺序访问，也支持随机访问
不需要访问磁盘，比隐式链接块
不产生外部碎片，方便拓展
文件分配表占用一定空间

### 索引分配

- 允许离散分配磁盘块，**每个文件对应一个索引表**，*记录文件的逻辑块和物理块的映射*
- 显式链接中，FAT 是一个磁盘对应一张

*索引表存放的物理块为索引块，文件数据存放的物理块为数据块*

![](img/Pasted%20image%2020240102102055.png)

**逻辑地址转物理地址**：
- 逻辑块号 i，OS 找到文件对应目录项 FCB
- 从 FCB 中找到索引表存放位置，从外存读入内存
- 再根据索引表找到 i 号逻辑块对应的外存中的物理块

**问题**：如果索引表大于一个磁盘块，*各级索引表最大不能超过一个块*
- *链接方案*
	- 多个索引块链接方式离散存放
	- 存在的问题是：如果想要找到最后一个逻辑块需要找到最后一个索引块，导致查找低效
- *多层索引*
	- 解决链接方案查找靠后逻辑块时的低效率问题
	- ![](img/Pasted%20image%2020240102102607.png)
	- k 层索引结构，且*顶层索引表未调入内存*：k+1 次读磁盘操作
- *混合索引*
	- 多种索引方案的结合
		- 直接地址索引：直接指向物理块（$8 KB$）
		- 一级间接索引：单层索引表 ($256 K$)
		- 二级间接索引：两层索引表 ($256*256=65536$)
	- 支持最大文件长度：$65800KB$ ($8+256+65536$)
	- *顶层索引表未调入内存*时，读磁盘操作：
		- 0~7 号，两次，*小文件读次数少（一般计算机中小文件更多）*
		- 8~263：三次
		- 264~：四次

**优缺点**：
- 支持随机访问
- 文件拓展方便
- 索引表需要占用空间

---
# 文件的逻辑结构和物理结构对比

**文件的逻辑结构**（用户视角的感受）
- 无结构文件
- 有结构文件
	- 顺序文件
		- 顺序存储
		- 链式存储
	- 索引文件
	- 索引顺序文件

**文件的物理结构**（OS 控制文件具体如何存储，但表现出的是用户视角感受到的逻辑结构）
- 连续分配
- 链接分配
- 索引分配

---
# 文件存储空间管理

[4.1\_6\_文件存储空间管理\_哔哩哔哩\_bilibili](https://www.bilibili.com/video/BV1YE411D7nH?t=1.8&p=64)

---
# 文件的基本操作



---
# 文件共享



---
# 文件保护



---
# 文件系统

## 层次结构
## 全局结构
## 虚拟文件系统


